<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistem Pakar Diagnosis Diabetes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-blue: #1e3a8a;
      --secondary-blue: #3b82f6;
      --light-blue: #93c5fd;
      --accent-blue: #2563eb;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      min-height: 100vh;
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--secondary-blue), var(--accent-blue));
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
    }
    
    .pulse-animation {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
      }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .symptom-card {
      transition: all 0.3s ease;
    }
    
    .symptom-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.1);
    }
    
    .gender-option {
      transition: all 0.3s ease;
      border: 2px solid #e5e7eb;
      cursor: pointer;
    }
    
    .gender-option:hover {
      border-color: var(--secondary-blue);
    }
    
    .gender-option.selected {
      border-color: var(--secondary-blue);
      background-color: #eff6ff;
    }
    
    .symptom-checkbox:checked + .symptom-label {
      background-color: #eff6ff;
      border-color: var(--secondary-blue);
    }
    
    .symptom-checkbox:checked + .symptom-label .checkmark {
      background-color: var(--secondary-blue);
      border-color: var(--secondary-blue);
    }
    
    .symptom-checkbox:checked + .symptom-label .checkmark i {
      opacity: 1;
    }
    
    .checkmark {
      width: 24px;
      height: 24px;
      border: 2px solid #d1d5db;
      border-radius: 6px;
      margin-right: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }
    
    .checkmark i {
      opacity: 0;
      color: white;
      font-size: 12px;
      transition: opacity 0.3s ease;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    .toast.success {
      background-color: #10b981;
    }
    
    .toast.error {
      background-color: #ef4444;
    }
    
    .toast.warning {
      background-color: #f59e0b;
    }
    
    /* Warna untuk tingkat risiko */
    .risk-high { 
      background-color: #fef2f2; 
      border-left: 4px solid #dc2626;
    }
    .risk-medium { 
      background-color: #fffbeb; 
      border-left: 4px solid #d97706;
    }
    .risk-low { 
      background-color: #f0fdf4; 
      border-left: 4px solid #16a34a;
    }
    
    .risk-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .risk-high-badge {
      background-color: #fee2e2;
      color: #dc2626;
    }
    
    .risk-medium-badge {
      background-color: #fef3c7;
      color: #d97706;
    }
    
    .risk-low-badge {
      background-color: #dcfce7;
      color: #16a34a;
    }
    
    /* Style untuk rekomendasi berdasarkan kategori */
    .recommendation-category {
      margin-bottom: 1rem;
    }
    
    .category-header {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      background: linear-gradient(90deg, #f8fafc, #e0f2fe);
      border-radius: 8px;
    }
    
    .category-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      color: white;
    }
    /* Tambahkan setelah .btn-primary { ... } */
.btn-pdf {
  background: linear-gradient(135deg, #10b981, #059669);
  transition: all 0.3s ease;
}

.btn-pdf:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
}
    
    .icon-pola-makan { background-color: #10b981; }
    .icon-aktivitas { background-color: #3b82f6; }
    .icon-medis { background-color: #ef4444; }
    .icon-pemantauan { background-color: #8b5cf6; }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-center p-4">
  <div class="w-full max-w-3xl glass-card rounded-2xl overflow-hidden transition-all duration-300">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-800 p-6 text-center">
      <div class="flex items-center justify-center space-x-3">
        <i class="fas fa-stethoscope text-white text-3xl"></i>
        <h1 class="text-3xl font-bold text-white">Sistem Pakar Diagnosis Diabetes</h1>
      </div>
      <p class="text-blue-100 mt-2">Deteksi dini risiko diabetes dengan sistem pakar kami</p>
    </div>

    <!-- Form -->
    <div class="p-8">
      <form id="diagnosisForm" class="space-y-6">
        <div class="space-y-4">
          <!-- nama_lengkap -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
              <i class="fas fa-user mr-2 text-blue-600"></i> Nama Lengkap
            </label>
            <input type="text" id="nama_lengkap" name="nama_lengkap" required 
                   class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition" 
                   placeholder="Masukkan nama lengkap Anda"/>
          </div>

          <!-- Usia -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
              <i class="fas fa-birthday-cake mr-2 text-blue-600"></i> Usia
            </label>
            <input type="number" id="usia" name="usia" required 
                   class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition" 
                   placeholder="Masukkan usia Anda" min="1" max="120"/>
          </div>

          <!-- Jenis Kelamin -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
              <i class="fas fa-venus-mars mr-2 text-blue-600"></i> Jenis Kelamin
            </label>
            <div class="grid grid-cols-2 gap-4">
              <div id="genderMale" class="gender-option p-4 rounded-lg bg-white text-center" onclick="selectGender('Laki-laki')">
                <i class="fas fa-mars text-blue-500 text-xl mb-2"></i>
                <p class="font-medium text-gray-800">Laki-laki</p>
              </div>
              
              <div id="genderFemale" class="gender-option p-4 rounded-lg bg-white text-center" onclick="selectGender('Perempuan')">
                <i class="fas fa-venus text-pink-500 text-xl mb-2"></i>
                <p class="font-medium text-gray-800">Perempuan</p>
              </div>
            </div>
            <input type="hidden" id="jenis_kelamin" name="jenis_kelamin" required>
          </div>

          <!-- Daftar Gejala -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
              <i class="fas fa-clipboard-list mr-2 text-blue-600"></i> Pilih Gejala yang Dialami:
            </label>
            <div id="symptomsContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div class="col-span-2 flex justify-center items-center py-4">
                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
                <span class="ml-3 text-gray-500">Memuat gejala...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Tombol Submit -->
        <button type="submit" 
                class="w-full btn-primary text-white py-3 px-4 rounded-lg transition-all duration-300 flex items-center justify-center font-medium pulse-animation">
          <i class="fas fa-stethoscope mr-2"></i> Diagnosa Sekarang
        </button>
      </form>

      <!-- Hasil -->
      <div id="hasilContainer" class="hidden mt-8 border-t border-gray-200 pt-6 fade-in">
        <div class="flex items-center space-x-3 mb-4">
          <div class="bg-blue-100 p-2 rounded-full">
            <i class="fas fa-clipboard-check text-blue-600 text-xl"></i>
          </div>
          <h2 class="text-xl font-semibold text-gray-800">Hasil Diagnosis</h2>
        </div>
        <div id="hasil" class="space-y-4 text-gray-700"></div>
        <div class="flex flex-col sm:flex-row justify-between mt-6 gap-3">
        </div>
      </div>
    </div>
  </div>

  <footer class="mt-8 text-center text-gray-600 text-sm">
    <p>© 2025 Sistem Pakar Diabetes. All rights reserved.</p>
  </footer>

  <script>
    // Base API URL
    const API_BASE_URL = '';
    
    // Utility Functions
    class ApiService {
        static async request(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
                ...options
            };

            if (options.body) {
                config.body = JSON.stringify(options.body);
            }

            try {
                const response = await fetch(url, config);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                
                const data = await response.json();
                console.log(`API Response ${endpoint}:`, data);
                return data;
            } catch (error) {
                console.error(`API Request failed ${endpoint}:`, error);
                throw error;
            }
        }

        static async get(endpoint) {
            return this.request(endpoint);
        }

        static async post(endpoint, data) {
            return this.request(endpoint, {
                method: 'POST',
                body: data
            });
        }
    }
    // =========================== FUNGSI DOWNLOAD PDF ===========================
class PDFService {
    static async generatePDF(result, userData, selectedSymptoms, recommendations) {
        try {
            // Tambahkan library jsPDF via CDN
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
            script.onload = () => this.createPDF(result, userData, selectedSymptoms, recommendations);
            document.head.appendChild(script);
        } catch (error) {
            console.error('Error generating PDF:', error);
            Toast.show('Gagal membuat PDF', 'error');
        }
    }

    static createPDF(result, userData, selectedSymptoms, recommendations) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Header
        doc.setFillColor(30, 58, 138);
        doc.rect(0, 0, 210, 30, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(20);
        doc.setFont('helvetica', 'bold');
        doc.text('LAPORAN DIAGNOSIS DIABETES', 105, 17, { align: 'center' });
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text('Sistem Pakar Diagnosis Diabetes', 105, 24, { align: 'center' });
        
        // Informasi Pasien
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('INFORMASI PASIEN', 20, 40);
        
        doc.setDrawColor(200, 200, 200);
        doc.line(20, 42, 190, 42);
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text(`Nama Lengkap: ${userData.nama_lengkap}`, 20, 50);
        doc.text(`Usia: ${userData.usia} tahun`, 20, 58);
        doc.text(`Jenis Kelamin: ${userData.jenis_kelamin}`, 20, 66);
        
        // Tanggal diagnosis
        const today = new Date();
        const formattedDate = today.toLocaleDateString('id-ID', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        doc.text(`Tanggal Diagnosis: ${formattedDate}`, 20, 74);
        
        // Hasil Diagnosis
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('HASIL DIAGNOSIS', 20, 90);
        doc.setDrawColor(200, 200, 200);
        doc.line(20, 92, 190, 92);
        
        doc.setFontSize(14);
        
        // Warna untuk tingkat risiko
        let riskColor;
        switch(result.tingkat_risiko) {
            case 'Tinggi': riskColor = [220, 38, 38]; break;
            case 'Sedang': riskColor = [217, 119, 6]; break;
            case 'Rendah': riskColor = [22, 163, 74]; break;
            default: riskColor = [22, 163, 74];
        }
        
        doc.setTextColor(riskColor[0], riskColor[1], riskColor[2]);
        doc.text(`Tingkat Risiko: ${result.tingkat_risiko}`, 20, 102);
        
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        
        // Diagnosis text
        const diagnosisLines = doc.splitTextToSize(result.diagnosis, 170);
        doc.text(diagnosisLines, 20, 112);
        
        doc.text(`Skor Akhir: ${result.skor_akhir}`, 20, 130);
        doc.text(`Jumlah Gejala Dipilih: ${result.gejala_count}`, 20, 138);
        
        // Gejala yang Dipilih
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('GEJALA YANG DIPILIH', 20, 155);
        doc.setDrawColor(200, 200, 200);
        doc.line(20, 157, 190, 157);
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        
        let yPos = 165;
        selectedSymptoms.forEach((symptom, index) => {
            if (yPos > 270) {
                doc.addPage();
                yPos = 20;
            }
            
            const symptomText = `${index + 1}. ${symptom.nama} (${symptom.kode_gejala || symptom.id})`;
            doc.text(symptomText, 25, yPos);
            yPos += 8;
        });
        
        // Rekomendasi
        doc.addPage();
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('REKOMENDASI', 20, 20);
        doc.setDrawColor(200, 200, 200);
        doc.line(20, 22, 190, 22);
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        
        let recYPos = 30;
        const groupedRecs = DiagnosisService.groupRecommendationsByCategory(recommendations);
        
        Object.keys(groupedRecs).forEach(kategori => {
            if (recYPos > 270) {
                doc.addPage();
                recYPos = 20;
            }
            
            // Kategori header
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(30, 58, 138);
            doc.text(kategori.toUpperCase(), 20, recYPos);
            recYPos += 8;
            
            // Rekomendasi items
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0);
            
            groupedRecs[kategori].forEach(rec => {
                if (recYPos > 270) {
                    doc.addPage();
                    recYPos = 20;
                }
                
                doc.text(`• ${rec.judul}`, 25, recYPos);
                recYPos += 6;
                
                const descLines = doc.splitTextToSize(rec.deskripsi, 165);
                doc.text(descLines, 30, recYPos);
                recYPos += (descLines.length * 6) + 4;
            });
            
            recYPos += 4;
        });
        
        // Footer
        const pageCount = doc.internal.getNumberOfPages();
        for(let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(10);
            doc.setTextColor(150, 150, 150);
            doc.text(`Halaman ${i} dari ${pageCount}`, 105, 287, { align: 'center' });
            doc.text('© 2025 Sistem Pakar Diagnosis Diabetes', 105, 293, { align: 'center' });
        }
        
        // Simpan PDF
        const fileName = `Diagnosis_Diabetes_${userData.nama_lengkap.replace(/\s+/g, '_')}_${today.getTime()}.pdf`;
        doc.save(fileName);
        
        Toast.show('PDF berhasil diunduh!', 'success');
    }
}

// Variabel global untuk menyimpan data diagnosis
let currentDiagnosisData = null;

// Fungsi untuk download PDF
function downloadPDF() {
    if (!currentDiagnosisData) {
        Toast.show('Tidak ada data diagnosis untuk diunduh', 'warning');
        return;
    }
    
    const { result, userData, selectedSymptoms, recommendations } = currentDiagnosisData;
    PDFService.generatePDF(result, userData, selectedSymptoms, recommendations);
}

    // Toast Notification
    class Toast {
        static show(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
    }

    // Service untuk Diagnosis
    class DiagnosisService {
        static async getSymptoms() {
            try {
                console.log('Memuat gejala dari API...');
                const response = await ApiService.get('/symptoms');
                console.log('Gejala yang diterima:', response);
                return response;
            } catch (error) {
                console.error('Error fetching symptoms:', error);
                return this.getFallbackSymptoms();
            }
        }

        static getFallbackSymptoms() {
            return [
                { id: 1, kode_gejala: 'G01', nama_gejala: 'Sering Merasa Haus', deskripsi: 'Merasa haus terus menerus meskipun sudah minum' },
                { id: 2, kode_gejala: 'G02', nama_gejala: 'Berat Badan Berlebih', deskripsi: 'Memiliki indeks massa tubuh di atas normal' },
                { id: 3, kode_gejala: 'G03', nama_gejala: 'Dalam Masa Kehamilan', deskripsi: 'Sedang hamil atau pernah mengalami diabetes gestasional' },
                { id: 4, kode_gejala: 'G04', nama_gejala: 'Kulit Sensitif', deskripsi: 'Kulit mudah terluka dan lama sembuh' },
                { id: 6, kode_gejala: 'G06', nama_gejala: 'Sering Sakit Kepala', deskripsi: 'Sering mengalami sakit kepala terutama di bagian belakang' },
                { id: 8, kode_gejala: 'G07', nama_gejala: 'Riwayat Keluarga Diabetes', deskripsi: 'Memiliki orang tua atau saudara kandung dengan diabetes' }
            ];
        }

        static async createUser(userData) {
            try {
                const response = await ApiService.post('/users', userData);
                console.log('User created response:', response);
                return response;
            } catch (error) {
                console.error('Error creating user:', error);
                throw error;
            }
        }

        static async addUserSymptoms(userId, symptomIds) {
            const promises = symptomIds.map(symptomId => {
                return ApiService.post('/user-symptoms', {
                    user_id: userId,
                    symptom_id: symptomId
                });
            });
            
            try {
                const results = await Promise.all(promises);
                console.log('User symptoms added:', results);
                return results;
            } catch (error) {
                console.error('Error adding user symptoms:', error);
                throw error;
            }
        }

        static async createDiagnosis(diagnosisData) {
            try {
                const response = await ApiService.post('/diagnoses', diagnosisData);
                console.log('Diagnosis created response:', response);
                return response;
            } catch (error) {
                console.error('Error creating diagnosis:', error);
                throw error;
            }
        }

        // Ambil rekomendasi dari database berdasarkan tingkat risiko
        static async getRecommendationsByRisk(tingkat_risiko) {
            try {
                console.log(`Mengambil rekomendasi untuk risiko: ${tingkat_risiko}`);
                
                // Ambil semua rekomendasi
                const response = await ApiService.get('/recommendations');
                
                // Filter rekomendasi berdasarkan tingkat risiko
                const filteredRecommendations = response.filter(rec => 
                    rec.untuk_tingkat_risiko === tingkat_risiko
                );
                
                console.log(`Rekomendasi untuk ${tingkat_risiko}:`, filteredRecommendations);
                
                // Jika tidak ada rekomendasi spesifik, ambil semua
                if (filteredRecommendations.length === 0) {
                    console.log('Tidak ada rekomendasi spesifik, mengambil semua rekomendasi');
                    return response;
                }
                
                return filteredRecommendations;
            } catch (error) {
                console.error('Error fetching recommendations:', error);
                return this.getFallbackRecommendations(tingkat_risiko);
            }
        }

        // Rekomendasi fallback jika API gagal
        static getFallbackRecommendations(tingkat_risiko) {
            const defaultRecommendations = {
                'Tinggi': [
                    { 
                        kategori: 'Pemeriksaan Medis', 
                        judul: 'Segera lakukan pemeriksaan', 
                        deskripsi: 'Bersegeralah melakukan pemeriksaan klinis pada dokter',
                        untuk_tingkat_risiko: 'Tinggi'
                    },
                    { 
                        kategori: 'Pola Makan', 
                        judul: 'Perbanyak serat', 
                        deskripsi: 'Perbanyak makan sayur hijau dan buah rendah gula',
                        untuk_tingkat_risiko: 'Tinggi'
                    },
                    { 
                        kategori: 'Pola Makan', 
                        judul: 'Kurangi gula sederhana', 
                        deskripsi: 'Kurangi makanan dan minuman manis, seperti teh, sirup, kue, permen, coklat, dll',
                        untuk_tingkat_risiko: 'Tinggi'
                    }
                ],
                'Sedang': [
                    { 
                        kategori: 'Aktivitas Fisik', 
                        judul: 'Olahraga rutin', 
                        deskripsi: 'Lakukan olahraga ringan 30 menit sehari',
                        untuk_tingkat_risiko: 'Sedang'
                    },
                    { 
                        kategori: 'Pola Makan', 
                        judul: 'Atur porsi makan', 
                        deskripsi: 'Makan dengan teratur dan hindari makan berlebih',
                        untuk_tingkat_risiko: 'Sedang'
                    },
                    { 
                        kategori: 'Pemantauan', 
                        judul: 'Catat gejala', 
                        deskripsi: 'Catat gejala yang muncul secara rutin',
                        untuk_tingkat_risiko: 'Sedang'
                    }
                ],
                'Rendah': [
                    { 
                        kategori: 'Pola Makan', 
                        judul: 'Perbanyak minum air putih', 
                        deskripsi: 'Minum air putih 6-8 gelas/hari',
                        untuk_tingkat_risiko: 'Rendah'
                    },
                    { 
                        kategori: 'Pemantauan', 
                        judul: 'Hindari sabun antiseptik keras', 
                        deskripsi: 'Sebisa mungkin hindari penggunakan sabun mandi atau tangan antiseptik yang keras',
                        untuk_tingkat_risiko: 'Rendah'
                    },
                    { 
                        kategori: 'Pemantauan', 
                        judul: 'Hindari mandi air panas terlalu lama', 
                        deskripsi: 'Jangan mandi dengan air panas terlalu lama atau terlalu sering',
                        untuk_tingkat_risiko: 'Rendah'
                    }
                ]
            };
            
            return defaultRecommendations[tingkat_risiko] || defaultRecommendations['Rendah'];
        }

        static calculateDiagnosis(selectedSymptoms, usia) {
            let totalBobot = 0;

            selectedSymptoms.forEach(symptom => {
                totalBobot += parseFloat(symptom.bobot || 0);
            });

            // Faktor usia
            if (usia > 45) {
                totalBobot += 0.20;
            } else if (usia > 30) {
                totalBobot += 0.10;
            }

            totalBobot = Math.min(totalBobot, 1.0);
            const skorAkhir = parseFloat(totalBobot.toFixed(2));

            let tingkat_risiko, diagnosis;

            if (skorAkhir >= 0.7) {
                tingkat_risiko = 'Tinggi';
                diagnosis = 'Anda memiliki risiko tinggi terkena diabetes. Segera periksakan diri ke dokter.';
            } else if (skorAkhir >= 0.4) {
                tingkat_risiko = 'Sedang';
                diagnosis = 'Anda memiliki risiko sedang terkena diabetes. Disarankan mengatur pola hidup.';
            } else {
                tingkat_risiko = 'Rendah';
                diagnosis = 'Risiko diabetes Anda rendah. Tetap jaga pola hidup sehat.';
            }

            return {
                tingkat_risiko,
                diagnosis,
                skor_akhir: skorAkhir,
                gejala_count: selectedSymptoms.length
            };
        }

        // Group rekomendasi berdasarkan kategori
        static groupRecommendationsByCategory(recommendations) {
            const grouped = {};
            
            recommendations.forEach(rec => {
                if (!grouped[rec.kategori]) {
                    grouped[rec.kategori] = [];
                }
                grouped[rec.kategori].push(rec);
            });
            
            return grouped;
        }

        // Get icon for kategori
        static getCategoryIcon(kategori) {
            const icons = {
                'Pola Makan': 'fas fa-utensils',
                'Aktivitas Fisik': 'fas fa-running',
                'Pemeriksaan Medis': 'fas fa-stethoscope',
                'Pemantauan': 'fas fa-clipboard-check'
            };
            
            return icons[kategori] || 'fas fa-lightbulb';
        }

        static getCategoryIconClass(kategori) {
            const classes = {
                'Pola Makan': 'icon-pola-makan',
                'Aktivitas Fisik': 'icon-aktivitas',
                'Pemeriksaan Medis': 'icon-medis',
                'Pemantauan': 'icon-pemantauan'
            };
            
            return classes[kategori] || 'icon-pemantauan';
        }
    }

    // Global variables
    let symptoms = [];
    let selectedSymptoms = [];
    let selectedGender = '';

    // Fungsi untuk memilih jenis kelamin
    function selectGender(gender) {
        selectedGender = gender;
        document.getElementById('jenis_kelamin').value = gender;
        
        const maleOption = document.getElementById('genderMale');
        const femaleOption = document.getElementById('genderFemale');
        
        if (gender === 'Laki-laki') {
            maleOption.classList.add('selected');
            femaleOption.classList.remove('selected');
        } else {
            femaleOption.classList.add('selected');
            maleOption.classList.remove('selected');
        }
    }

    // Fungsi untuk memuat gejala
    async function loadSymptoms() {
        try {
            const container = document.getElementById('symptomsContainer');
            
            container.innerHTML = `
                <div class="col-span-2 flex justify-center items-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
                    <span class="ml-3 text-gray-500">Memuat gejala...</span>
                </div>
            `;
            
            symptoms = await DiagnosisService.getSymptoms();
            
            if (symptoms && symptoms.length > 0) {
                displaySymptoms();
            } else {
                throw new Error('Tidak ada data gejala');
            }
        } catch (error) {
            console.error('Error loading symptoms:', error);
            symptoms = DiagnosisService.getFallbackSymptoms();
            displaySymptoms();
            Toast.show('Menggunakan data gejala lokal', 'warning');
        }
    }

    // =========================== PERBAIKAN: Fungsi untuk menampilkan gejala TANPA bobot dan tingkat risiko ===========================
    function displaySymptoms() {
        const container = document.getElementById('symptomsContainer');
        container.innerHTML = '';
        
        if (!symptoms || symptoms.length === 0) {
            container.innerHTML = `
                <div class="col-span-2 text-center py-8">
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mb-2"></i>
                    <p class="text-gray-500">Tidak ada gejala yang tersedia</p>
                </div>
            `;
            return;
        }
        
        symptoms.forEach(symptom => {
            const symptomElement = document.createElement('div');
            symptomElement.className = 'symptom-card bg-white p-4 rounded-lg border border-gray-200';
            
            const symptomName = symptom.nama_gejala || symptom.name || `Gejala ${symptom.id}`;
            const symptomDesc = symptom.deskripsi || symptom.description || '';
            
            // TAMPILKAN HANYA NAMA DAN DESKRIPSI, TANPA BOBOT DAN TINGKAT KEPARAHAN
            symptomElement.innerHTML = `
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" value="${symptom.id}" class="symptom-checkbox hidden">
                    <div class="symptom-label flex items-start rounded-lg p-3 transition w-full hover:bg-gray-50">
                        <div class="checkmark">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="flex-1">
                            <span class="text-gray-700 font-medium block">${symptomName}</span>
                            ${symptomDesc ? `<p class="text-sm text-gray-500 mt-1">${symptomDesc}</p>` : ''}
                            <!-- HAPUS BAGIAN INI: Bobot dan tingkat keparahan TIDAK DITAMPILKAN -->
                        </div>
                    </div>
                </label>
            `;
            
            container.appendChild(symptomElement);
            
            const checkbox = symptomElement.querySelector('.symptom-checkbox');
            const label = symptomElement.querySelector('.symptom-label');
            
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    selectedSymptoms.push({
                        id: symptom.id,
                        nama: symptomName,
                        bobot: symptom.bobot || 0.1,
                        kode_gejala: symptom.kode_gejala
                    });

                    label.classList.add('bg-blue-50', 'border', 'border-blue-300');
                } else {
                    selectedSymptoms = selectedSymptoms.filter(s => s.id !== symptom.id);
                    label.classList.remove('bg-blue-50', 'border', 'border-blue-300');
                }
            });
        });
    }

    // Fungsi untuk menampilkan rekomendasi dengan kategori
    function displayRecommendations(recommendations) {
        // Group rekomendasi berdasarkan kategori
        const groupedRecs = DiagnosisService.groupRecommendationsByCategory(recommendations);
        
        let recommendationsHTML = '<div class="recommendations-container">';
        
        // Loop melalui setiap kategori
        Object.keys(groupedRecs).forEach(kategori => {
            const categoryRecs = groupedRecs[kategori];
            const iconClass = DiagnosisService.getCategoryIconClass(kategori);
            const icon = DiagnosisService.getCategoryIcon(kategori);
            
            recommendationsHTML += `
                <div class="recommendation-category">
                    <div class="category-header">
                        <div class="category-icon ${iconClass}">
                            <i class="${icon}"></i>
                        </div>
                        <h4 class="font-medium text-gray-800">${kategori}</h4>
                    </div>
                    <ul class="space-y-2">
                        ${categoryRecs.map(rec => `
                            <li class="flex items-start bg-white p-3 rounded-lg border border-gray-200">
                                <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
                                <div class="flex-1">
                                    <h5 class="font-medium text-gray-800 mb-1">${rec.judul}</h5>
                                    <p class="text-sm text-gray-600">${rec.deskripsi}</p>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        });
        
        recommendationsHTML += '</div>';
        
        return recommendationsHTML;
    }

    async function displayResult(result, recommendations) {
    const hasilContainer = document.getElementById('hasilContainer');
    const hasilElement = document.getElementById('hasil');
    
    let riskClass, riskBadgeClass;
    switch(result.tingkat_risiko) {
        case 'Tinggi':
            riskClass = 'risk-high';
            riskBadgeClass = 'risk-high-badge';
            break;
        case 'Sedang':
            riskClass = 'risk-medium';
            riskBadgeClass = 'risk-medium-badge';
            break;
        case 'Rendah':
            riskClass = 'risk-low';
            riskBadgeClass = 'risk-low-badge';
            break;
        default:
            riskClass = 'risk-low';
            riskBadgeClass = 'risk-low-badge';
    }
    
    // Simpan data untuk PDF
    const nama = document.getElementById('nama_lengkap').value.trim();
    const usia = document.getElementById('usia').value;
    
    currentDiagnosisData = {
        result: result,
        userData: {
            nama_lengkap: nama,
            usia: usia,
            jenis_kelamin: selectedGender
        },
        selectedSymptoms: selectedSymptoms,
        recommendations: recommendations
    };
    
    // Tampilkan rekomendasi yang sudah dikelompokkan
    const recommendationsHTML = displayRecommendations(recommendations);
    
    hasilElement.innerHTML = `
        <div class="${riskClass} p-6 rounded-lg">
            <div class="flex justify-between items-start mb-4">
                <h3 class="font-semibold text-lg">Hasil Diagnosis</h3>
                <div class="flex items-center space-x-2">
                    <span class="risk-badge ${riskBadgeClass}">${result.tingkat_risiko}</span>
                    <span class="text-sm text-gray-500">Skor: ${result.skor_akhir}</span>
                </div>
            </div>
            <p class="mb-4 text-gray-700">${result.diagnosis}</p>
            
            <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                <p class="text-sm text-blue-700">
                    <i class="fas fa-info-circle mr-2"></i>
                    Anda memilih ${result.gejala_count} gejala yang berkaitan dengan diabetes
                </p>
            </div>
            
            ${result.user_id ? `
            <div class="mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
                <p class="text-sm text-green-700">
                    <i class="fas fa-check-circle mr-2"></i>
                    Data diagnosis telah disimpan di database
                </p>
            </div>
            ` : ''}
        </div>
        
        <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-6 rounded-lg border border-blue-200">
            <h3 class="font-semibold text-lg text-blue-800 mb-3 flex items-center">
                <i class="fas fa-lightbulb mr-2"></i> Rekomendasi untuk Anda (Risiko ${result.tingkat_risiko})
            </h3>
            ${recommendationsHTML}
        </div>
    `;
    
    hasilContainer.classList.remove('hidden');
    hasilContainer.scrollIntoView({ behavior: 'smooth' });
    
    // Tampilkan tombol-tombol aksi (Reset dan Download PDF)
    const actionButtons = document.createElement('div');
    actionButtons.className = 'flex flex-col sm:flex-row justify-between mt-6 gap-3';
    actionButtons.innerHTML = `
        <button onclick="resetForm()" 
                class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded-lg transition flex items-center justify-center flex-1 sm:flex-none">
            <i class="fas fa-redo mr-2"></i> Mulai Diagnosa Baru
        </button>
        <button onclick="downloadPDF()" 
                class="btn-pdf text-white px-4 py-2 rounded-lg transition flex items-center justify-center flex-1 sm:flex-none">
            <i class="fas fa-file-pdf mr-2"></i> Download PDF
        </button>
    `;
    
    // Hapus tombol sebelumnya jika ada
    const existingButtons = hasilContainer.querySelector('.action-buttons');
    if (existingButtons) {
        existingButtons.remove();
    }
    
    // Tambah class untuk identifikasi
    actionButtons.classList.add('action-buttons');
    hasilContainer.appendChild(actionButtons);
}

    function resetForm() {
    document.getElementById('diagnosisForm').reset();
    selectedSymptoms = [];
    selectedGender = '';
    
    // TAMBAHKAN BARIS INI:
    currentDiagnosisData = null; // Reset data PDF
    
    document.getElementById('genderMale').classList.remove('selected');
    document.getElementById('genderFemale').classList.remove('selected');
    
    document.querySelectorAll('.symptom-checkbox').forEach(checkbox => {
        checkbox.checked = false;
        const label = checkbox.nextElementSibling;
        label.classList.remove('bg-blue-50', 'border', 'border-blue-300');
    });
    
    document.getElementById('hasilContainer').classList.add('hidden');
    
    Toast.show('Form telah direset', 'success');
}

    // Event listener untuk form submission
    document.getElementById('diagnosisForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Validasi
        const nama = document.getElementById('nama_lengkap').value.trim();
        const usia = document.getElementById('usia').value;
        
        if (!nama || !usia || !selectedGender) {
            Toast.show('Silakan lengkapi semua data', 'warning');
            return;
        }
        
        if (selectedSymptoms.length === 0) {
            Toast.show('Silakan pilih minimal satu gejala', 'warning');
            return;
        }
        
        const submitButton = this.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Memproses...';
        submitButton.disabled = true;
        
        try {
            // 1. Simpan user
            const userData = {
                nama_lengkap: nama,
                usia: parseInt(usia),
                jenis_kelamin: selectedGender
            };
            
            console.log('Menyimpan user:', userData);
            const userResult = await DiagnosisService.createUser(userData);
            const userId = userResult.id || userResult.insertId;
            
            // 2. Simpan gejala user
            const symptomIds = selectedSymptoms.map(s => s.id);
            await DiagnosisService.addUserSymptoms(userId, symptomIds);
            
            // 3. Hitung diagnosis
            const usiaNum = parseInt(usia);
            const diagnosisResult = DiagnosisService.calculateDiagnosis(selectedSymptoms, usiaNum);
            
            // 4. Ambil rekomendasi dari database
            console.log('Mengambil rekomendasi untuk risiko:', diagnosisResult.tingkat_risiko);
            const recommendations = await DiagnosisService.getRecommendationsByRisk(diagnosisResult.tingkat_risiko);
            console.log('Rekomendasi yang didapat:', recommendations);
            
            // 5. Simpan diagnosis
            const diagnosisData = {
                user_id: userId,
                tingkat_risiko: diagnosisResult.tingkat_risiko,
                skor_akhir: diagnosisResult.skor_akhir,
                rekomendasi_khusus: diagnosisResult.diagnosis
            };
            
            await DiagnosisService.createDiagnosis(diagnosisData);
            
            // 6. Tampilkan hasil dengan rekomendasi
            await displayResult({
                ...diagnosisResult,
                user_id: userId
            }, recommendations);
            
            Toast.show('Diagnosis berhasil! Rekomendasi telah dimuat dari database.', 'success');
            
        } catch (error) {
            console.error('Error in diagnosis process:', error);
            
            // Fallback: tampilkan diagnosis lokal jika API gagal
            const usiaNum = parseInt(usia);
            const diagnosisResult = DiagnosisService.calculateDiagnosis(selectedSymptoms, usiaNum);
            const fallbackRecs = DiagnosisService.getFallbackRecommendations(diagnosisResult.tingkat_risiko);
            
            displayResult({
                ...diagnosisResult,
                user_id: null
            }, fallbackRecs);
            
            Toast.show('Diagnosis berhasil! (Menggunakan rekomendasi lokal)', 'warning');
        } finally {
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
        }
    });

    // Memuat gejala saat halaman dimuat
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Aplikasi dimuat');
        loadSymptoms();
    });
  </script>
</body>
</html>
