<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Diagnosis Diabetes</title>
</head>
<body>

<h2>Form Diagnosis Diabetes</h2>

<form id="diagnosisForm">
    <input type="text" id="nama" placeholder="Nama Lengkap" required><br>
    <input type="number" id="usia" placeholder="Usia" required><br>

    <select id="jenis_kelamin" required>
        <option value="">Pilih Jenis Kelamin</option>
        <option value="L">Laki-laki</option>
        <option value="P">Perempuan</option>
    </select>

    <h3>Gejala</h3>
    <div id="gejalaContainer"></div>

    <button type="submit">Proses Diagnosis</button>
</form>

<div id="hasil"></div>

<script>
const API = ''; // SAME DOMAIN

let symptoms = [];

async function loadSymptoms() {
    const res = await fetch(`${API}/symptoms`);
    symptoms = await res.json();

    const container = document.getElementById('gejalaContainer');
    container.innerHTML = '';

    symptoms.forEach(s => {
        container.innerHTML += `
            <label>
                <input type="checkbox" value="${s.id}" data-bobot="${s.bobot}">
                ${s.nama_gejala}
            </label><br>
        `;
    });
}

loadSymptoms();

document.getElementById('diagnosisForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const nama = document.getElementById('nama').value;
    const usia = document.getElementById('usia').value;
    const jk = document.getElementById('jenis_kelamin').value;

    // CREATE USER
    const userRes = await fetch(`${API}/users`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            nama_lengkap: nama,
            usia,
            jenis_kelamin: jk
        })
    });

    const user = await userRes.json();
    const userId = user.id;

    let skor = 0;

    document.querySelectorAll('input[type=checkbox]:checked').forEach(async cb => {
        skor += parseFloat(cb.dataset.bobot);

        await fetch(`${API}/user-symptoms`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: userId,
                symptom_id: cb.value
            })
        });
    });

    let risiko = 'Rendah';
    if (skor >= 0.7) risiko = 'Tinggi';
    else if (skor >= 0.4) risiko = 'Sedang';

    await fetch(`${API}/diagnoses`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            user_id: userId,
            tingkat_risiko: risiko,
            skor_akhir: skor,
            rekomendasi_khusus: risiko === 'Tinggi'
                ? 'Segera periksa ke dokter'
                : 'Jaga pola hidup sehat'
        })
    });

    document.getElementById('hasil').innerHTML = `
        <h3>Hasil Diagnosis</h3>
        <p>Tingkat Risiko: <b>${risiko}</b></p>
        <p>Skor Akhir: ${skor.toFixed(2)}</p>
    `;
});
</script>

</body>
</html>
